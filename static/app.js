const profiles = [
  {
    name: "–ú–∞—Ä–∏–Ω–∞, 27",
    location: "–ú–æ—Å–∫–≤–∞ ¬∑ UI/UX –¥–∏–∑–∞–π–Ω–µ—Ä",
    bio: "–í–¥–æ—Ö–Ω–æ–≤–ª—è—é—Å—å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º –∏—Å–∫—É—Å—Å—Ç–≤–æ–º, –∏–≥—Ä–∞—é –Ω–∞ —É–∫—É–ª–µ–ª–µ –∏ –Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é –≤—ã—Ö–æ–¥–Ω—ã–µ –±–µ–∑ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π.",
    tags: ["–ò—Å–∫—É—Å—Å—Ç–≤–æ", "–ú—É–∑—ã–∫–∞", "–í–∏–Ω–æ", "–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"],
    photo:
      "https://images.unsplash.com/photo-1544723795-3fb6469f5b39?auto=format&fit=crop&w=900&q=80",
  },
  {
    name: "–ò–≥–æ—Ä—å, 31",
    location: "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ ¬∑ –ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫",
    bio: "–õ—é–±–ª—é –Ω–∞—Ö–æ–¥–∏—Ç—å –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏ –≤ –¥–∞–Ω–Ω—ã—Ö –∏ –≤ –∂–∏–∑–Ω–∏. –í —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è –±–µ–≥–∞—é –º–∞—Ä–∞—Ñ–æ–Ω—ã –∏ –∏–∑—É—á–∞—é –≥–∞—Å—Ç—Ä–æ–Ω–æ–º–∏—é.",
    tags: ["–ë–µ–≥", "–ö–æ—Ñ–µ", "–ì–æ—Ä–æ–¥", "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è"],
    photo:
      "https://images.unsplash.com/photo-1533237264985-ee6757c00606?auto=format&fit=crop&w=900&q=80",
  },
  {
    name: "–ù–∞—Å—Ç—è, 25",
    location: "–ö–∞–∑–∞–Ω—å ¬∑ –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π",
    bio: "–°–æ–±–∏—Ä–∞—é –ª—é–¥–µ–π –≤–æ–∫—Ä—É–≥ —è—Ä–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π. –û–±–æ–∂–∞—é –∂–∏–≤—É—é –º—É–∑—ã–∫—É, –Ω–æ—á–Ω—ã–µ –ø—Ä–æ–≥—É–ª–∫–∏ –∏ –∏—Å–∫—Ä–µ–Ω–Ω–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã.",
    tags: ["–§–µ—Å—Ç–∏–≤–∞–ª–∏", "–ù–æ—á–Ω—ã–µ –ø—Ä–æ–≥—É–ª–∫–∏", "–ò–Ω–¥–∏", "–ö—É–ª–∏–Ω–∞—Ä–∏—è"],
    photo:
      "https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=900&q=80",
  },
  {
    name: "–ê—Ä—Ç—ë–º, 29",
    location: "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫ ¬∑ –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä",
    bio: "–ü—Ä–æ–µ–∫—Ç–∏—Ä—É—é –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞, –≥–¥–µ –ª—é–¥—è–º –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ –∂–∏—Ç—å –∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—Ç—å—Å—è. –ò—â—É —Å–ø—É—Ç–Ω–∏–∫–∞ –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π –ø–æ —Å–Ω–µ–∂–Ω—ã–º —Å–∫–ª–æ–Ω–∞–º.",
    tags: ["–°–Ω–æ—É–±–æ—Ä–¥", "–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞", "–§–∏–ª—å–º–æ–∫–∞–º–µ—Ä–∞", "–°–∫–∞–ª—ã"],
    photo:
      "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&w=900&q=80",
  },
  {
    name: "–ï–≤–∞, 28",
    location: "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ ¬∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ",
    bio: "–°–Ω–∏–º–∞—é –∏—Å—Ç–æ—Ä–∏–∏ –ª—é–±–≤–∏ –≤ –≥–æ—Ä–æ–¥–µ –∏ –∑–∞ –µ–≥–æ –ø—Ä–µ–¥–µ–ª–∞–º–∏. –¶–µ–Ω—é —á—É–≤—Å—Ç–≤–æ —é–º–æ—Ä–∞, –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å –∏ —Å–ø–æ–Ω—Ç–∞–Ω–Ω—ã–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è.",
    tags: ["–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è", "–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è", "–°—Ç–µ–Ω–¥–∞–ø", "–ü—Ä–∏—Ä–æ–¥–∞"],
    photo:
      "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=900&q=80",
  },
];

const state = {
  queue: [],
  nextIndex: 0,
  history: [],
  isDragging: false,
  startX: 0,
  activeCard: null,
  user: null,
};

const stackEl = document.querySelector(".card-stack");
const template = document.getElementById("profile-card-template");
const toastTemplate = document.getElementById("result-toast-template");
const actionButtons = document.querySelectorAll(".action-button");
const subscriptionButton = document.querySelector("[data-open-subscription]");
const subscriptionModal = document.querySelector("[data-subscription-modal]");
const closeSubscription = document.querySelector("[data-close-subscription]");
const planButtons = document.querySelectorAll(".plan-card button");
const loginModal = document.querySelector("[data-login-modal]");
const registerModal = document.querySelector("[data-register-modal]");
const loginButton = document.querySelector("[data-open-login]");
const registerButton = document.querySelector("[data-open-register]");
const closeLoginButton = document.querySelector("[data-close-login]");
const closeRegisterButton = document.querySelector("[data-close-register]");
const switchToRegisterButton = document.querySelector("[data-switch-to-register]");
const switchToLoginButton = document.querySelector("[data-switch-to-login]");
const loginForm = document.querySelector("[data-login-form]");
const registerForm = document.querySelector("[data-register-form]");
const loginError = document.querySelector("[data-login-error]");
const registerError = document.querySelector("[data-register-error]");
const userChip = document.querySelector("[data-user-chip]");
const userNameLabel = document.querySelector("[data-user-name]");
const logoutButton = document.querySelector("[data-logout]");

function toggleModal(modal, open) {
  if (!modal) return;
  modal.hidden = !open;
  const firstInput = modal.querySelector("input");
  if (open && firstInput) {
    requestAnimationFrame(() => firstInput.focus());
  }
}

function setUser(user) {
  state.user = user;
  if (user) {
    userChip.hidden = false;
    userNameLabel.textContent = user.display_name;
    loginButton.hidden = true;
    registerButton.hidden = true;
  } else {
    userChip.hidden = true;
    userNameLabel.textContent = "";
    loginButton.hidden = false;
    registerButton.hidden = false;
  }
}

function showAuthError(element, message) {
  if (!element) return;
  if (!message) {
    element.hidden = true;
    element.textContent = "";
    return;
  }
  element.hidden = false;
  element.textContent = message;
}

async function loadCurrentUser() {
  try {
    const response = await fetch("/api/me", { credentials: "same-origin" });
    if (!response.ok) {
      setUser(null);
      return;
    }
    const data = await response.json();
    setUser(data.user);
  } catch (error) {
    console.error("failed to load user", error);
    setUser(null);
  }
}

function createCard(profile, position) {
  const node = template.content.firstElementChild.cloneNode(true);
  const img = node.querySelector("img");
  const nameEl = node.querySelector(".name");
  const metaEl = node.querySelector(".meta");
  const bioEl = node.querySelector(".bio");
  const tagsEl = node.querySelector(".tags");

  img.src = profile.photo;
  img.alt = profile.name;
  nameEl.textContent = profile.name;
  metaEl.textContent = profile.location;
  bioEl.textContent = profile.bio;

  tagsEl.innerHTML = "";
  profile.tags.forEach((tag, idx) => {
    const li = document.createElement("li");
    li.textContent = tag;
    if (idx % 2 === 1) li.classList.add("alt");
    tagsEl.appendChild(li);
  });

  node.style.transform = `translateY(${position * 12}px) scale(${1 - position * 0.02})`;
  node.style.zIndex = String(50 - position);

  addGestureListeners(node);
  return node;
}

function updateStackTransforms() {
  const cards = [...stackEl.querySelectorAll(".profile-card")];
  cards.forEach((card, idx) => {
    const transitions = card.style.transition
      .split(",")
      .map((part) => part.trim())
      .filter(Boolean)
      .filter((part) => !part.startsWith("transform"));
    transitions.push("transform 0.3s ease");
    card.style.transition = transitions.join(", ");
    card.style.transform = `translateY(${idx * 12}px) scale(${1 - idx * 0.02})`;
    card.style.zIndex = String(50 - idx);
    const onTransitionEnd = (event) => {
      if (event.propertyName !== "transform") return;
      const remaining = card.style.transition
        .split(",")
        .map((part) => part.trim())
        .filter(Boolean)
        .filter((part) => !part.startsWith("transform"));
      card.style.transition = remaining.join(", ");
      card.removeEventListener("transitionend", onTransitionEnd);
    };
    card.addEventListener("transitionend", onTransitionEnd);
  });
}

function initStack() {
  stackEl.innerHTML = "";
  state.queue = [];
  state.nextIndex = 0;

  const cardsToRender = Math.min(3, profiles.length);
  for (let i = 0; i < cardsToRender; i += 1) {
    const profileIndex = state.nextIndex;
    const card = createCard(profiles[profileIndex], i);
    card.dataset.profileIndex = String(profileIndex);
    stackEl.appendChild(card);
    state.queue.push(profileIndex);
    state.nextIndex = (state.nextIndex + 1) % profiles.length;
  }
}

function findNextProfileIndex() {
  if (profiles.length === 0) return null;
  for (let i = 0; i < profiles.length; i += 1) {
    const candidate = (state.nextIndex + i) % profiles.length;
    if (!state.queue.includes(candidate) || state.queue.length >= profiles.length) {
      state.nextIndex = (candidate + 1) % profiles.length;
      return candidate;
    }
  }
  return null;
}

function showToast(type, message) {
  const toast = toastTemplate.content.firstElementChild.cloneNode(true);
  toast.textContent = message;
  toast.classList.add(type);
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 2600);
}

function handleDecision(decision, card) {
  if (!card) return;
  const profileIndex = Number(card.dataset.profileIndex);

  if (decision === "superlike") {
    card.classList.add("superlike-highlight");
  }
  card.classList.add(decision === "like" || decision === "superlike" ? "exit-right" : "exit-left");
  card.style.pointerEvents = "none";

  state.history.push({ profileIndex, decision });
  const queuePosition = state.queue.indexOf(profileIndex);
  if (queuePosition !== -1) {
    state.queue.splice(queuePosition, 1);
  }

  if (decision === "like") {
    showToast("success", "–¢—ã –æ—Ç–ø—Ä–∞–≤–∏–ª –ª–∞–π–∫ ‚ú®");
  } else if (decision === "superlike") {
    showToast("success", "–°—É–ø–µ—Ä–ª–∞–π–∫! –¢–µ–±—è –∑–∞–º–µ—Ç—è—Ç –±—ã—Å—Ç—Ä–µ–µ üåü");
  } else if (decision === "dislike") {
    showToast("error", "–ü—Ä–æ—Ñ–∏–ª—å —Å–∫—Ä—ã—Ç");
  }

  setTimeout(() => {
    card.remove();
    const nextIndex = findNextProfileIndex();
    if (nextIndex !== null && !state.queue.includes(nextIndex)) {
      const newCard = createCard(profiles[nextIndex], state.queue.length);
      newCard.dataset.profileIndex = String(nextIndex);
      stackEl.appendChild(newCard);
      state.queue.push(nextIndex);
    }
    updateStackTransforms();
  }, 320);
}

function rewindLast() {
  const last = state.history.pop();
  if (!last) {
    showToast("error", "–ü–æ–∫–∞ –Ω–µ—á–µ–≥–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å");
    return;
  }
  if (state.queue.includes(last.profileIndex)) {
    showToast("error", "–≠—Ç–æ—Ç –ø—Ä–æ—Ñ–∏–ª—å —É–∂–µ –æ—Ç–∫—Ä—ã—Ç");
    return;
  }

  const card = createCard(profiles[last.profileIndex], 0);
  card.dataset.profileIndex = String(last.profileIndex);
  card.style.opacity = "0";
  card.style.transform = "translateY(-30px) scale(0.96)";
  stackEl.prepend(card);
  state.queue.unshift(last.profileIndex);

  requestAnimationFrame(() => {
    updateStackTransforms();
    requestAnimationFrame(() => {
      const transitions = card.style.transition
        .split(",")
        .map((part) => part.trim())
        .filter(Boolean)
        .filter((part) => !part.startsWith("opacity"));
      transitions.push("opacity 0.35s ease");
      card.style.transition = transitions.join(", ");
      card.style.opacity = "1";
    });
  });

  if (state.queue.length > 3) {
    const removedIndex = state.queue.pop();
    const lastCard = stackEl.lastElementChild;
    if (lastCard) lastCard.remove();
    if (removedIndex !== undefined && removedIndex !== last.profileIndex) {
      state.nextIndex = (removedIndex + 1) % profiles.length;
    }
  } else {
    const tailIndex = state.queue[state.queue.length - 1];
    state.nextIndex = (tailIndex + 1) % profiles.length;
  }

  showToast("success", "–í–µ—Ä–Ω—É–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å");
}

function addGestureListeners(card) {
  card.addEventListener("pointerdown", onPointerDown);
  card.addEventListener("pointermove", onPointerMove);
  card.addEventListener("pointerup", onPointerUp);
  card.addEventListener("pointercancel", onPointerEnd);
  card.addEventListener("pointerleave", onPointerEnd);
}

function onPointerDown(event) {
  if (!event.isPrimary) return;
  state.isDragging = true;
  state.startX = event.clientX;
  state.activeCard = event.currentTarget;
  state.activeCard.setPointerCapture(event.pointerId);
  state.activeCard.style.transition = "none";
}

function onPointerMove(event) {
  if (!state.isDragging || !state.activeCard) return;
  const deltaX = event.clientX - state.startX;
  const rotation = deltaX / 14;
  state.activeCard.style.transform = `translate(${deltaX}px, 0) rotate(${rotation}deg)`;
}

function onPointerUp(event) {
  if (!state.isDragging || !state.activeCard) return;
  const deltaX = event.clientX - state.startX;
  const threshold = 120;

  state.isDragging = false;
  state.activeCard.releasePointerCapture(event.pointerId);

  if (Math.abs(deltaX) > threshold) {
    const decision = deltaX > 0 ? "like" : "dislike";
    const card = state.activeCard;
    state.activeCard = null;
    handleDecision(decision, card);
  } else {
    state.activeCard.style.transition = "transform 0.3s ease";
    updateStackTransforms();
    state.activeCard = null;
  }
}

function onPointerEnd() {
  if (!state.isDragging || !state.activeCard) return;
  state.isDragging = false;
  state.activeCard.style.transition = "transform 0.3s ease";
  updateStackTransforms();
  state.activeCard = null;
}

function handleButtonClick(event) {
  const button = event.currentTarget;
  const action = button.dataset.action;
  const topCard = stackEl.querySelector(".profile-card");
  if (!topCard) return;

  if (action === "rewind") {
    rewindLast();
    return;
  }

  handleDecision(action, topCard);
}

actionButtons.forEach((button) => button.addEventListener("click", handleButtonClick));

subscriptionButton.addEventListener("click", () => {
  subscriptionModal.hidden = false;
});

closeSubscription.addEventListener("click", () => {
  subscriptionModal.hidden = true;
});

subscriptionModal.addEventListener("click", (event) => {
  if (event.target === subscriptionModal) {
    subscriptionModal.hidden = true;
  }
});

planButtons.forEach((button) => {
  button.addEventListener("click", () => {
    const planTitle = button.closest(".plan-card")?.querySelector("h3")?.textContent ?? "Aura";
    showToast("success", `${planTitle} –ø–æ—á—Ç–∏ —Ç–≤–æ–π! –ü—Ä–æ–≤–µ—Ä—å –ø–æ—á—Ç—É`);
    subscriptionModal.hidden = true;
  });
});

function bindAuthInteractions() {
  loginButton?.addEventListener("click", () => {
    toggleModal(registerModal, false);
    showAuthError(loginError, "");
    toggleModal(loginModal, true);
  });

  registerButton?.addEventListener("click", () => {
    toggleModal(loginModal, false);
    showAuthError(registerError, "");
    toggleModal(registerModal, true);
  });

  closeLoginButton?.addEventListener("click", () => toggleModal(loginModal, false));
  closeRegisterButton?.addEventListener("click", () => toggleModal(registerModal, false));

  switchToRegisterButton?.addEventListener("click", () => {
    toggleModal(loginModal, false);
    showAuthError(registerError, "");
    toggleModal(registerModal, true);
  });

  switchToLoginButton?.addEventListener("click", () => {
    toggleModal(registerModal, false);
    showAuthError(loginError, "");
    toggleModal(loginModal, true);
  });

  loginModal?.addEventListener("click", (event) => {
    if (event.target === loginModal) toggleModal(loginModal, false);
  });

  registerModal?.addEventListener("click", (event) => {
    if (event.target === registerModal) toggleModal(registerModal, false);
  });

  loginForm?.addEventListener("submit", handleLoginSubmit);
  registerForm?.addEventListener("submit", handleRegisterSubmit);
  logoutButton?.addEventListener("click", handleLogout);
}

async function handleLoginSubmit(event) {
  event.preventDefault();
  if (!loginForm) return;
  showAuthError(loginError, "");

  const formData = new FormData(loginForm);
  const payload = {
    email: formData.get("email"),
    password: formData.get("password"),
  };

  try {
    const response = await fetch("/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
      credentials: "same-origin",
    });

    if (!response.ok) {
      const message = response.status === 401 ? "–ù–µ–≤–µ—Ä–Ω–∞—è –ø–æ—á—Ç–∞ –∏–ª–∏ –ø–∞—Ä–æ–ª—å" : "–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
      showAuthError(loginError, message);
      return;
    }

    const data = await response.json();
    loginForm.reset();
    toggleModal(loginModal, false);
    setUser(data.user);
    showToast("success", `–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, ${data.user.display_name}!`);
  } catch (error) {
    console.error("login error", error);
    showAuthError(loginError, "–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
  }
}

async function handleRegisterSubmit(event) {
  event.preventDefault();
  if (!registerForm) return;
  showAuthError(registerError, "");

  const formData = new FormData(registerForm);
  const payload = {
    display_name: formData.get("display_name"),
    email: formData.get("email"),
    password: formData.get("password"),
  };

  if (!payload.password || payload.password.length < 8) {
    showAuthError(registerError, "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –∫–æ—Ä–æ—á–µ 8 —Å–∏–º–≤–æ–ª–æ–≤");
    return;
  }

  try {
    const response = await fetch("/api/register", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
      credentials: "same-origin",
    });

    if (!response.ok) {
      let message = "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
      if (response.status === 409) {
        message = "–¢–∞–∫–æ–π email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω";
      } else if (response.status === 400) {
        message = "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤–≤–µ–¥—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö";
      }
      showAuthError(registerError, message);
      return;
    }

    const data = await response.json();
    registerForm.reset();
    toggleModal(registerModal, false);
    setUser(data.user);
    showToast("success", `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${data.user.display_name}!`);
  } catch (error) {
    console.error("register error", error);
    showAuthError(registerError, "–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
  }
}

async function handleLogout() {
  try {
    await fetch("/api/logout", {
      method: "POST",
      credentials: "same-origin",
    });
  } catch (error) {
    console.error("logout error", error);
  }
  setUser(null);
  showToast("success", "–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞");
}

document.addEventListener("keydown", (event) => {
  if (event.key !== "Escape") return;
  let closed = false;
  if (!subscriptionModal.hidden) {
    subscriptionModal.hidden = true;
    closed = true;
  }
  if (loginModal && !loginModal.hidden) {
    toggleModal(loginModal, false);
    closed = true;
  }
  if (registerModal && !registerModal.hidden) {
    toggleModal(registerModal, false);
    closed = true;
  }
  if (closed) event.stopPropagation();
});

bindAuthInteractions();
loadCurrentUser();
initStack();
updateStackTransforms();
